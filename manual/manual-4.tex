% -*- coding: utf-8 -*-
% !TEX program = lualatex
\documentclass[oneside]{book}

\input{manual.sty}
\CodeHigh{lite}
\setcounter{chapter}{3}

\begin{document}

\chapter{Use Long Tables}
\label{chap:long}

\section{A simple example}

To make a decent long table with header and footer, it is better to separate header/footer as
\underline{table head/foot} (which includes caption, footnotes, continuation text)
and \underline{row head/foot} (which includes some rows of the table that should appear in every page).
By this approach, alternating row colors work as expected.

\NewTblrTheme{fancy}{
  \SetTblrStyle{firsthead}{font=\bfseries}
  \SetTblrStyle{firstfoot}{fg=blue2}
  \SetTblrStyle{middlefoot}{\itshape}
  \SetTblrStyle{caption-tag}{red2}
}
\begin{longtblr}[
  theme = fancy,
  caption = {A Long Long Long Long Long Long Long Table},
  entry = {Short Caption},
  label = {tblr:test},
  note{a} = {It is the first footnote.},
  note{$\dag$} = {It is the second long long long long long long footnote.},
  remark{Note} = {Some general note. Some general note. Some general note.},
  remark{Source} = {Made up by myself. Made up by myself. Made up by myself.},
]{
  colspec = {XXX}, width = 0.85\linewidth,
  rowhead = 2, rowfoot = 1,
  row{odd} = {gray9}, row{even} = {brown9},
  row{1-2} = {purple7}, row{Z} = {blue7},
}
\hline
 Head    & Head  & Head    \\
\hline
 Head    & Head  & Head    \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta\TblrNote{a}       & Eta    \\
\hline
 Iota    & Kappa\TblrNote{$\dag$} & Lambda \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Foot    & Foot  & Foot    \\
\hline
\end{longtblr}

As you can see in the above example, the appearance of long tables of \PP{tabularray} package
is similar to that of \PP{threeparttablex} packages.
It supports table footnotes, but not page footnotes.

\newpage

The source code for the above long table is shown below. It is mainly self-explanatory.

\begin{codehigh}
\NewTblrTheme{fancy}{
  \SetTblrStyle{firsthead}{font=\bfseries}
  \SetTblrStyle{firstfoot}{fg=blue2}
  \SetTblrStyle{middlefoot}{\itshape}
  \SetTblrStyle{caption-tag}{red2}
}
\begin{longtblr}[
  theme = fancy,
  caption = {A Long Long Long Long Long Long Long Table},
  entry = {Short Caption},
  label = {tblr:test},
  note{a} = {It is the first footnote.},
  note{$\dag$} = {It is the second long long long long long long footnote.},
  remark{Note} = {Some general note. Some general note. Some general note.},
  remark{Source} = {Made up by myself. Made up by myself. Made up by myself.},
]{
  colspec = {XXX}, width = 0.85\linewidth,
  rowhead = 2, rowfoot = 1,
  row{odd} = {gray9}, row{even} = {brown9},
  row{1-2} = {purple7}, row{Z} = {blue7},
}
\hline
 Head    & Head  & Head    \\
\hline
 Head    & Head  & Head    \\
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta\TblrNote{a}       & Eta    \\
\hline
 Iota    & Kappa\TblrNote{$\dag$} & Lambda \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
......
\hline
 Alpha   & Beta  & Gamma   \\
\hline
 Epsilon & Zeta  & Eta     \\
\hline
 Iota    & Kappa & Lambda  \\
\hline
 Nu      & Xi    & Omicron \\
\hline
 Rho     & Sigma & Tau     \\
\hline
 Phi     & Chi   & Psi     \\
\hline
 Foot    & Foot  & Foot    \\
\hline
\end{longtblr}
\end{codehigh}

As you can see in the above code, we typeset long tables with \EE{longtblr} environment.
And we can totally separate contents and styles of long tables with \PP{tabularray} package.

Row head and row foot consist of some lines of the table and should appear in every page.
Their options are inner specifications and should be put in the mandatory argument of the \EE{longtblr} environment.
In the above example, We set \KV{rowhead=2} and \KV{rowfoot=1}.

\begin{spectblr}[
  caption = {Inner Specifications for Row Heads and Row Foots}
]{}
  Key Name    & Key Description & Initial Value \\
  \V{rowhead} & number of the first rows of the table appear in every page & \V{0} \\
  \V{rowfoot} & number of the last rows of the table appear in every page  & \V{0} \\
\end{spectblr}

Table head and table foot consist of the caption, continuation text, footnotes and remarks.
Their options are outer specifications and should be put in the optional argument of the \EE{longtblr} environment.

\begin{spectblr}[
  caption = {Outer Specifications for Table Heads and Table Foots}
]{}
  Key Name            & Key Description & Initial Value \\
  \K{headsep}         & vertical space between table head and table body & \V{6pt} \\
  \K{footsep}         & vertical space between table foot and table body & \V{6pt} \\
  \K{presep}          & vertical space between table head and the above text & \VV{1.5\bigskipamount} \\
  \K{postsep}         & vertical space between table foot and the below text & \VV{1.5\bigskipamount} \\
  \K{theme}           & table theme (including settings for templates and styles) & \None \\
  \K{caption}         & table caption & \None \\
  \K{entry}           & short table caption to be put in List of Tables & \None \\
  \K{label}           & table label & \None \\
  \KK{note{<name>}}   & table note with \V{<name>} as tag & \None \\
  \KK{remark{<name>}} & table remark with \V{<name>} as tag & \None \\
\end{spectblr}

If you write \KV{entry=none}, \PP{tabularray} package will not add an entry in List of Tables.
Therefore \KV{caption=text,entry=none} is similar to \CC{\caption[]{text}} in \PP{longtable}.

If you write \KV{label=none}, \PP{tabularray} package will not step \CO{table} counter,
and set the \EN{caption-tag} and \EN{caption-sep} elements (see below) to empty.
Therefore \KV{caption=text,entry=none,label=none} is similar to \CC{\caption*{text}}
in \PP{longtable}, except for the counter.

\section{Customize templates}

\subsection{Overview of templates}

The template system for table heads and table foots in \PP{tabularray} is largely inspired
by \PP{beamer}, \PP{caption} and \PP{longtable} packages. For elements in Table \ref{tblr:element},
you can use \CC{\DeclareTblrTemplate} to define and modify templates,
and use \CC{\SetTblrTemplate} to choose default templates. In defining templates,
you can include other templates with \CC{\UseTblrTemplate} and \CC{\ExpTblrTemplate} commands.

\begin{spectblr}[
  caption = {Elements for Table Heads and Table Foots},
  label = {tblr:element},
]{}
  Element Name     & Element Description and Default Template \\
  \V{contfoot-text}& continuation text in the foot, normally ``Continued on next page'' \\
  \V{contfoot}     & continuation paragraph in the foot, normally including \V{contfoot-text} template \\
  \V{conthead-text}& continuation text in the head, normally ``(Continued)'' \\
  \V{conthead}     & continuation paragraph in the head, normally including \V{conthead-text} template \\
  \V{caption-tag}  & caption tag, normally like ``Table 4.2'' \\
  \V{caption-sep}  & caption separator, normally like ``:\quad'' \\
  \V{caption-text} & caption text, normally using user provided value \\
  \V{caption}      & including \V{caption-tag} + \V{caption-sep} + \V{caption-text} \\
  \V{note-tag}     & note tag, normally using user provided value \\
  \V{note-sep}     & note separator, normally like ``\enskip'' \\
  \V{note-text}    & note tag, normally using user provided value \\
  \V{note}         & including \V{note-tag} + \V{note-sep} + \V{note-text} \\
  \V{remark-tag}   & remark tag, normally using user provided value \\
  \V{remark-sep}   & remark separator, normally like ``:\enskip'' \\
  \V{remark-text}  & remark text, normally using user provided value\\
  \V{remark}       & including \V{remark-tag} + \V{remark-sep} + \V{remark-text} \\
  \V{firsthead}    & table head on the first page, normally including \V{caption} template \\
  \V{middlehead}   & table head on middle pages, normally including \V{caption} and \V{conthead} templates \\
  \V{lasthead}     & table head on the last page, normally including \V{caption} and \V{conthead} templates \\
  \V{head}         & setting all of \V{firsthead}, \V{middlehead} and \V{lasthead} \\
  \V{firstfoot}    & table foot on the first page, normally including \V{contfoot} template \\
  \V{middlefoot}   & table foot on middle pages, normally including \V{contfoot} template \\
  \V{lastfoot}     & table foot on the last page, normally including \V{note} and \V{remark} templates \\
  \V{foot}         & setting all of \V{firstfoot}, \V{middlefoot} and \V{lastfoot} \\
\end{spectblr}

An element which only includes short text is called a \underline{sub element}.
Normally there is one \TT{-} in the name of a sub element.
An element which includes one or more paragraphs is called a \underline{main element}.
Normally there isn't any \TT{-} in the name of a main element.

For each of the above elements, two templates \TN{normal} and \TN{empty} are always defined.
You can select one of them with \CC{\SetTblrTemplate} command.

\subsection{Continuation templates}

Let us have a look at the code for defining templates of continuation text first:%
\footnote{To tell the truth, the default \texttt{conthead-text} and \texttt{contfoot-text}
are actually stored in commands \texttt{\string\tblrcontheadname} and \texttt{\string\tblrcontfootname}
respectively. And you may contribute your translations of them to \textbf{babel} package.}

\begin{codehigh}
\DeclareTblrTemplate{contfoot-text}{normal}{Continued on next page}
\SetTblrTemplate{contfoot-text}{normal}
\DeclareTblrTemplate{conthead-text}{normal}{(Continued)}
\SetTblrTemplate{conthead-text}{normal}
\end{codehigh}

In the above code, command \CC{\DeclareTblrTemplate} defines the templates with name \TN{normal},
and then command \CC{\SetTblrTemplate} sets the templates with name \TN{normal} as default.
The \TN{normal} template is always defined and set as default for any element in \PP{tabularray}.
Therefore you had better use another name when defining new templates.

If you use \TN{default} as template name in \CC{\DeclareTblrTemplate},
you define and set it as default at the same time.
Therefore the above code can be written in another way:

\begin{codehigh}
\DeclareTblrTemplate{contfoot-text}{default}{Continued on next page}
\DeclareTblrTemplate{conthead-text}{default}{(Continued)}
\end{codehigh}

You may modify the code to customize continuation text to fit your needs.

The templates for \EN{contfoot} and \EN{conthead} normally
include the templates of their sub elements with \CC{\UseTblrTemplate} commands.
But you can also handle user settings such as horizontal alignment here.

\begin{codehigh}
\DeclareTblrTemplate{contfoot}{default}{\UseTblrTemplate{contfoot-text}{default}}
\DeclareTblrTemplate{conthead}{default}{\UseTblrTemplate{conthead-text}{default}}
\end{codehigh}

\subsection{Caption templates}

Normally a caption consists of three parts, and their templates are defined with the follow code:

\begin{codehigh}
\DeclareTblrTemplate{caption-tag}{default}{Table\hspace{0.25em}\thetable}
\DeclareTblrTemplate{caption-sep}{default}{:\enskip}
\DeclareTblrTemplate{caption-text}{default}{\InsertTblrText{caption}}
\end{codehigh}

The command \CC{\InsertTblrText{caption}} inserts the value of \K{caption} key,
which you could write in the optional argument of \EE{longtblr} environment.

The \EN{caption} template normally includes three sub templates with \CC{\UseTblrTemplate} commands:
The \EN{caption} template will be used in \EN{firsthead} template.

\begin{codehigh}
\DeclareTblrTemplate{caption}{default}{
  \UseTblrTemplate{caption-tag}{default}
  \UseTblrTemplate{caption-sep}{default}
  \UseTblrTemplate{caption-text}{default}
}
\end{codehigh}

Furthermore \EN{capcont} template includes \EN{conthead} template as well.
The \EN{capcont} template will be used in \EN{middlehead} and \EN{lasthead} templates.

\begin{codehigh}
\DeclareTblrTemplate{capcont}{default}{
  \UseTblrTemplate{caption-tag}{default}
  \UseTblrTemplate{caption-sep}{default}
  \UseTblrTemplate{caption-text}{default}
  \UseTblrTemplate{conthead-text}{default}
}
\end{codehigh}

\subsection{Note and remark templates}

The templates for table notes can be defined like this:

\begin{codehigh}
\DeclareTblrTemplate{note-tag}{default}{\textsuperscript{\InsertTblrNoteTag}}
\DeclareTblrTemplate{note-sep}{default}{\space}
\DeclareTblrTemplate{note-text}{default}{\InsertTblrNoteText}
\end{codehigh}
\begin{codehigh}
\DeclareTblrTemplate{note}{default}{
  \MapTblrNotes{
    \noindent
    \UseTblrTemplate{note-tag}{default}
    \UseTblrTemplate{note-sep}{default}
    \UseTblrTemplate{note-text}{default}
    \par
  }
}
\end{codehigh}

The \CC{\MapTblrNotes} command loops for all table notes,
which are written in the optional argument of \EE{longtblr} environment.
Inside the loop, you can use \CC{\InsertTblrNoteTag} and \CC{\InsertTblrNoteText}
commands to insert current note tag and note text, respectively.

The definition of remark templates are similar to note templates.
\nopagebreak
\begin{codehigh}
\DeclareTblrTemplate{remark-tag}{default}{\InsertTblrRemarkTag}
\DeclareTblrTemplate{remark-sep}{default}{:\space}
\DeclareTblrTemplate{remark-text}{default}{\InsertTblrRemarkText}
\end{codehigh}
\begin{codehigh}
\DeclareTblrTemplate{remark}{default}{
  \MapTblrRemarks{
    \noindent
    \UseTblrTemplate{remark-tag}{default}
    \UseTblrTemplate{remark-sep}{default}
    \UseTblrTemplate{remark-text}{default}
    \par
  }
}
\end{codehigh}

\subsection{Head and foot templates}

The templates for table heads and foots are defined as including other templates:

\begin{codehigh}
\DeclareTblrTemplate{firsthead}{default}{
  \UseTblrTemplate{caption}{default}
}
\DeclareTblrTemplate{middlehead,lasthead}{default}{
  \UseTblrTemplate{capcont}{default}
}
\DeclareTblrTemplate{firstfoot,middlefoot}{default}{
  \UseTblrTemplate{contfoot}{default}
}
\DeclareTblrTemplate{lastfoot}{default}{
  \UseTblrTemplate{note}{default}
  \UseTblrTemplate{remark}{default}
}
\end{codehigh}

Note that you can define the same template for multiple elements in \CC{\DeclareTblrTemplate} command.
If you only want to show table caption in the first page, you may change the definitions of
\EN{middlehead} and \EN{lasthead} elements:

\begin{codehigh}
\DeclareTblrTemplate{middlehead,lasthead}{default}{
  \UseTblrTemplate{conthead}{default}
}
\end{codehigh}

\section{Change styles}

All available keys for template elements are described in Table \ref{key:element}.

\begin{spectblr}[
  caption = {Keys for the Styles of Elements},
  label = {key:element},
  remark{Note} = {In most cases, you can omit the underlined key names and write only their values.
                  The keys \K{halign}, \K{indent} and \K{hang} are only for main templates.}
]{}
  Key Name               & Key Description  & Initial Value\\
  \underline{\K{fg}}     & foreground color & \None \\
  \underline{\K{font}}   & font commands    & \None \\
  \underline{\K{halign}}
     & horizontal alignment: \V{l} (left), \V{c} (center), \V{r} (right) or \V{j} (justify)
                                            & \V{j} \\
  \K{indent}             & parindent value  & \V{0pt} \\
  \K{hang}               & hangindent value & \V{0pt} or \V{0.7em} \\
\end{spectblr}

You may change the styles of elements with \CC{\SetTblrStyle} command:

\begin{codehigh}
\SetTblrStyle{firsthead}{font=\bfseries}
\SetTblrStyle{firstfoot}{fg=blue2}
\SetTblrStyle{middlefoot}{\itshape}
\SetTblrStyle{caption-tag}{red2}
\end{codehigh}

When you write \CC{\UseTblrTemplate{element}{default}} in defining a template,
beside including template code of the \EN{element}, the foreground color and font commands
of the \EN{element} will be set up automatically.
In contrast, \CC{\ExpTblrTemplate{element}{default}} will only include template code.

\section{Define themes}

You may define your own themes for table heads and foots with \CC{\NewTblrTheme} command.
a theme consists of some template and style settings. For example:
\nopagebreak
\begin{codehigh}
\NewTblrTheme{fancy}{
  \DeclareTblrTemplate{conthead}{default}{[Continued]}
  \SetTblrStyle{firsthead}{font=\bfseries}
  \SetTblrStyle{firstfoot}{fg=blue2}
  \SetTblrStyle{middlefoot}{\itshape}
  \SetTblrStyle{caption-tag}{red2}
}
\end{codehigh}

After defining the theme \V{fancy}, you can use it
by writing \KV{theme=fancy} in the optional argument of \EE{longtblr} environment.

\section{Control page breaks}

Just like \PP{longtable} package, inside \EE{longtblr} environment,
you can use \CC{\\\\*} or \CC{\nopagebreak} to prohibit a page break,
and use \CC{\pagebreak} to force a page break.

\section{Floatable tall tables}

There is also a \EE{talltblr} environment as an alternative to \EE{threeparttable} environment.
It can not cross multiple pages, but it can be put inside \EE{table} environment.

\begin{demohigh}
TEXT\begin{talltblr}[
  caption = {Long Long Long Long Tabular},
  entry = {Short Caption},
  label = {tblr:tall},
  note{a} = {It is the first footnote.},
  note{$\dag$} = {It is the second long long long long long long footnote.},
]{
  colspec = {XXX}, width = 0.5\linewidth, hlines,
}
  Alpha   & Beta  & Gamma \\
  Epsilon & Zeta  & Eta\TblrNote{a} \\
  Iota    & Kappa & Lambda\TblrNote{$\dag$} \\
\end{talltblr}TEXT
\end{demohigh}

\end{document}
